name: Publish to MCP Registry

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Validate only (do not publish)'
        required: false
        default: 'false'
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Download MCP Publisher
        run: |
          # Get latest release download URL
          DOWNLOAD_URL=$(curl -s https://api.github.com/repos/modelcontextprotocol/registry/releases/latest | jq -r '.assets[] | select(.name == "mcp-publisher_linux_amd64.tar.gz") | .browser_download_url')
          echo "Downloading from: $DOWNLOAD_URL"
          curl -fsSL "$DOWNLOAD_URL" -o mcp-publisher.tar.gz
          tar -xzf mcp-publisher.tar.gz
          chmod +x mcp-publisher
          ./mcp-publisher --version
          echo "MCP Publisher downloaded successfully"

      - name: Validate server.json
        run: |
          echo "Validating server.json..."
          # Check JSON syntax
          if ! jq empty server.json 2>/dev/null; then
            echo "âŒ Invalid JSON syntax"
            exit 1
          fi
          echo "âœ… JSON syntax valid"

          # Check required fields
          NAME=$(jq -r '.name' server.json)
          VERSION=$(jq -r '.version' server.json)
          DESCRIPTION=$(jq -r '.description' server.json)

          if [ "$NAME" == "null" ] || [ -z "$NAME" ]; then
            echo "âŒ Missing required field: name"
            exit 1
          fi
          if [ "$VERSION" == "null" ] || [ -z "$VERSION" ]; then
            echo "âŒ Missing required field: version"
            exit 1
          fi

          echo "âœ… Required fields present"
          echo "  Name: $NAME"
          echo "  Version: $VERSION"
          echo "  Description: $DESCRIPTION"

          # Check for packages or remotes
          PACKAGES=$(jq '.packages | length' server.json)
          REMOTES=$(jq '.remotes | length' server.json)

          if [ "$PACKAGES" == "0" ] && [ "$REMOTES" == "0" ]; then
            echo "âŒ Must have at least one package or remote"
            exit 1
          fi

          echo "âœ… Has $PACKAGES package(s) and $REMOTES remote(s)"
          echo "âœ… Validation passed"

      - name: Authenticate with GitHub OIDC
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "Authenticating with MCP Registry via GitHub OIDC..."
          ./mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "Publishing to MCP Registry..."
          ./mcp-publisher publish server.json
          echo "âœ… Published successfully!"

      - name: Dry Run Summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ðŸ” Dry run completed - validation only, no publish"

      - name: Summary
        run: |
          echo "## MCP Registry Publication" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server**: io.github.creator35lwb-web/verifimind-genesis" >> $GITHUB_STEP_SUMMARY
          VERSION=$(jq -r ".version" server.json) && echo "**Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Endpoint**: https://verifimind.ysenseai.org/mcp" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "**Mode**: Validation only (dry run)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode**: Published to registry" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ Server is now available at:" >> $GITHUB_STEP_SUMMARY
            echo "https://registry.modelcontextprotocol.io" >> $GITHUB_STEP_SUMMARY
          fi
